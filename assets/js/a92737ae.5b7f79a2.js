"use strict";(self.webpackChunkbri_b_dev_github_io=self.webpackChunkbri_b_dev_github_io||[]).push([[3732],{917:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>i,toc:()=>d});var i=r(4820),s=r(4848),t=r(8453),a=r(7293);const l={slug:"terraform-patterns-aks-azure",title:"Terraform Patterns f\xfcr AKS & Azure",authors:"brigitte",tags:["terraform","aks","azure","rbac","network-policy","modules","cicd"],date:new Date("2025-02-03T00:00:00.000Z"),description:"Erfahrungen mit modularen Terraform-Setups f\xfcr AKS \u2013 von Modul-Design \xfcber RBAC bis zu Network Policies und CI/CD."},o=void 0,c={authorsImageUrls:[void 0]},d=[{value:"\ud83e\uddf1 Modul-Architektur: Trennen nach Verantwortlichkeiten",id:"-modul-architektur-trennen-nach-verantwortlichkeiten",level:2},{value:"\ud83d\udd27 Beispiel: AKS-Modul (Interface)",id:"-beispiel-aks-modul-interface",level:2},{value:"\ud83e\udeaa RBAC &amp; Identit\xe4ten: h\xe4ufige Fallstricke",id:"-rbac--identit\xe4ten-h\xe4ufige-fallstricke",level:2},{value:"1) Azure RBAC vs. Kubernetes RBAC",id:"1-azure-rbac-vs-kubernetes-rbac",level:3},{value:"2) Kubelet/ACR Berechtigungen",id:"2-kubeletacr-berechtigungen",level:3},{value:"3) Netzwerk\u2011Rollen",id:"3-netzwerkrollen",level:3},{value:"\ud83d\udd10 Network Policies: Praxis statt Theorie",id:"-network-policies-praxis-statt-theorie",level:2},{value:"Baseline (Namespaceseitig) \u2013 Default Deny",id:"baseline-namespaceseitig--default-deny",level:3},{value:"Allow: Ingress vom Ingress-Controller + DNS Egress",id:"allow-ingress-vom-ingress-controller--dns-egress",level:3},{value:"\ud83c\udf10 Netzwerk-Setup: bew\xe4hrte Optionen",id:"-netzwerk-setup-bew\xe4hrte-optionen",level:2},{value:"\ud83e\uddea Environments, Workspaces &amp; State",id:"-environments-workspaces--state",level:2},{value:"\ud83d\udea6 CI/CD &amp; Sicherheit",id:"-cicd--sicherheit",level:2},{value:"\ud83d\udce6 Komplettes AKS-Beispiel (gek\xfcrzt)",id:"-komplettes-aks-beispiel-gek\xfcrzt",level:2},{value:"\ud83e\udded Checkliste \u2013 Was gerne schiefgeht",id:"-checkliste--was-gerne-schiefgeht",level:2},{value:"\ud83d\udccc Fazit",id:"-fazit",level:2},{value:"\ud83d\udce6 Vollst\xe4ndiges AKS\u2011Modul (Beispiel)",id:"-vollst\xe4ndiges-aksmodul-beispiel",level:2},{value:"\ud83d\ude80 Azure DevOps Pipeline f\xfcr Terraform AKS",id:"-azure-devops-pipeline-f\xfcr-terraform-aks",level:2},{value:"\ud83d\udccc Ergebnis",id:"-ergebnis",level:2},{value:"\ud83e\udde9 Produktionsreifes AKS\u2011Modul (Terraform)",id:"-produktionsreifes-aksmodul-terraform",level:2},{value:"\ud83d\udd01 Azure DevOps Pipeline (Terraform Plan/Apply, Multi\u2011Env)",id:"-azure-devops-pipeline-terraform-planapply-multienv",level:2},{value:"Hinweise &amp; Best Practices",id:"hinweise--best-practices",level:3},{value:"\ud83d\udd17 Beispiel: Verwendung des AKS\u2011Moduls in <code>infra/env/dev/main.tf</code>",id:"-beispiel-verwendung-des-aksmoduls-in-infraenvdevmaintf",level:2}];function u(e){const n={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",hr:"hr",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["AKS-Projekte wachsen schnell: ",(0,s.jsx)(n.strong,{children:"Cluster, Node Pools, Identities, Netzwerke, ACR, Policies"})," \u2013 und pro Umgebung (dev/test/prod) variieren Parameter. Ohne Struktur wird die Codebasis fragil. In diesem Beitrag zeige ich ",(0,s.jsx)(n.strong,{children:"bew\xe4hrte Terraform-Patterns"})," f\xfcr Azure & AKS aus Projekten, inkl. ",(0,s.jsx)(n.strong,{children:"RBAC"}),"- und ",(0,s.jsx)(n.strong,{children:"Network-Policy"}),"-Fallstricken."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-modul-architektur-trennen-nach-verantwortlichkeiten",children:"\ud83e\uddf1 Modul-Architektur: Trennen nach Verantwortlichkeiten"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Ziel:"})," Wiederverwendbare, klar geschnittene Module statt eines \u201eMonolithen\u201c."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"infra/\n\u251c\u2500 modules/\n\u2502  \u251c\u2500 network/                 # VNet, Subnets, NSGs, UDR/NAT\n\u2502  \u251c\u2500 aks/                     # AKS-Cluster + Pools\n\u2502  \u251c\u2500 identity/                # UAMI/MI + Role Assignments\n\u2502  \u251c\u2500 acr/                     # Container Registry\n\u2502  \u251c\u2500 monitoring/              # Log Analytics, Insights\n\u2502  \u251c\u2500 policies/                # Azure Policy + AKS Add-Ons\n\u2502  \u2514\u2500 dns/                     # Private DNS Zonen\n\u251c\u2500 env/\n\u2502  \u251c\u2500 dev/\n\u2502  \u2502  \u251c\u2500 main.tf               # Zusammensetzen der Module\n\u2502  \u2502  \u251c\u2500 variables.tfvars\n\u2502  \u2502  \u2514\u2500 backend.tf            # Remote State\n\u2502  \u2514\u2500 prod/\n\u2502     \u251c\u2500 ...\n\u2514\u2500 global/\n   \u2514\u2500 rg.tf                    # Ressourcengruppen, Tags, Management\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pattern:"})," Environments sind ",(0,s.jsx)(n.strong,{children:"Kompositionen"})," aus Modulen. Jedes Modul besitzt eine ",(0,s.jsx)(n.strong,{children:"klare API"})," (Inputs/Outputs) und minimale Seiteneffekte."]}),"\n",(0,s.jsx)(a.A,{type:"tip",title:"Keep Inputs simple",children:(0,s.jsxs)(n.p,{children:["Vermeide riesige, verschachtelte ",(0,s.jsx)(n.code,{children:"object"}),"-Variablen. Lieber mehrere flache Inputs mit Defaults \u2013 das reduziert ",(0,s.jsx)(n.code,{children:"Unknown"}),"-Diffs und erleichtert Upgrades."]})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-beispiel-aks-modul-interface",children:"\ud83d\udd27 Beispiel: AKS-Modul (Interface)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'variable "name" { type = string }\nvariable "location" { type = string }\nvariable "resource_group_name" { type = string }\nvariable "kubernetes_version" { type = string }\nvariable "network_profile" {\n  type = object({\n    plugin           = string   # azure, kubenet, cni_overlay\n    pod_cidr         = optional(string)\n    service_cidr     = string\n    dns_service_ip   = string\n    outbound_type    = string   # loadBalancer, userDefinedRouting, managedNATGateway\n  })\n}\nvariable "enable_azure_rbac" { type = bool, default = true }\nvariable "aad_admin_group_object_ids" { type = list(string), default = [] }\nvariable "system_node_pool" {\n  type = object({\n    name       = string\n    vm_size    = string\n    min_count  = number\n    max_count  = number\n    os_sku     = optional(string, "Ubuntu")\n  })\n}\nvariable "user_node_pools" {\n  type = list(object({\n    name       = string\n    vm_size    = string\n    min_count  = number\n    max_count  = number\n    taints     = optional(list(string), [])\n    labels     = optional(map(string), {})\n    mode       = optional(string, "User")\n  }))\n  default = []\n}\noutput "kubelet_identity_principal_id" { value = azurerm_kubernetes_cluster.this.kubelet_identity[0].object_id }\noutput "cluster_id" { value = azurerm_kubernetes_cluster.this.id }\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Hinweis:"})," Abh\xe4ngig von Provider-Versionen unterscheiden sich Block\u2011Namen/Flags. Kapsle Version-Spezifika ",(0,s.jsx)(n.strong,{children:"im Modul"})," und biete stabile Inputs nach au\xdfen."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-rbac--identit\xe4ten-h\xe4ufige-fallstricke",children:"\ud83e\udeaa RBAC & Identit\xe4ten: h\xe4ufige Fallstricke"}),"\n",(0,s.jsx)(n.h3,{id:"1-azure-rbac-vs-kubernetes-rbac",children:"1) Azure RBAC vs. Kubernetes RBAC"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Azure RBAC f\xfcr Kubernetes"}),' ("AKS-managed AAD") vereinfacht die AuthN/AuthZ, aber ',(0,s.jsx)(n.strong,{children:"Mapping & Propagation"})," dauern ggf. Sekunden/Minuten."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Pattern:"})," Lege ",(0,s.jsx)(n.strong,{children:"AAD-Gruppen"})," f\xfcr Cluster\u2011Rollen an (z.\u202fB. ",(0,s.jsx)(n.code,{children:"aks-admins"}),", ",(0,s.jsx)(n.code,{children:"aks-devs"}),") und reiche deren Objekt\u2011IDs als Modul\u2011Input durch."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'# Pseudocode \u2013 Modul nutzt diese IDs\nvariable "aad_admin_group_object_ids" { type = list(string) }\n# Im Cluster\u2011Block: AAD/RBAC aktivieren und Gruppen als Admins registrieren\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Anti\u2011Pattern:"})," Einzelne User direkt hinterlegen \u2192 schwer wartbar, keine Rotation."]}),"\n",(0,s.jsx)(n.h3,{id:"2-kubeletacr-berechtigungen",children:"2) Kubelet/ACR Berechtigungen"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Damit Nodes Images ziehen k\xf6nnen: ",(0,s.jsx)(n.code,{children:"AcrPull"})," auf ",(0,s.jsx)(n.strong,{children:"ACR"})," f\xfcr die ",(0,s.jsx)(n.strong,{children:"Kubelet-Identity"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Zus\xe4tzlich: Build/Push\u2011Pipeline \u2192 ",(0,s.jsx)(n.code,{children:"AcrPush"})," f\xfcr CI\u2011Service\u2011Principal oder UAMI."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'resource "azurerm_role_assignment" "kubelet_acr_pull" {\n  scope                = azurerm_container_registry.acr.id\n  role_definition_name = "AcrPull"\n  principal_id         = module.aks.kubelet_identity_principal_id\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"3-netzwerkrollen",children:"3) Netzwerk\u2011Rollen"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Bei ",(0,s.jsx)(n.strong,{children:"UDR/NAT Gateway"}),": ",(0,s.jsx)(n.code,{children:"Network Contributor"})," auf Subnet/RouteTable f\xfcr die ",(0,s.jsx)(n.strong,{children:"AKS\u2011MI"})," (Cluster Identity) \u2013 sonst schl\xe4gt Provisioning/Scale fehl."]}),"\n"]}),"\n",(0,s.jsx)(a.A,{type:"caution",title:"Eventual Consistency",children:(0,s.jsxs)(n.p,{children:["Role Assignments sind ",(0,s.jsx)(n.strong,{children:"eventual consistent"}),". Plane Wartezeiten/",(0,s.jsx)(n.code,{children:"depends_on"})," ein oder nutze ein Retry\u2011Wrapper\u2011Modul."]})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-network-policies-praxis-statt-theorie",children:"\ud83d\udd10 Network Policies: Praxis statt Theorie"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Ziel:"})," Default\u2011Deny auf Pod\u2011Ebene + gezielte Allow\u2011Regeln."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"CNI/Policy-Matrix"})," unterscheidet sich je nach AKS\u2011Version: Azure CNI (Classic/Overlay) & Kubenet verhalten sich unterschiedlich."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Pattern:"})," Parametrisiere Policy\u2011Engine (",(0,s.jsx)(n.code,{children:"azure"}),", ",(0,s.jsx)(n.code,{children:"calico"}),") als Modul\u2011Input und generiere ",(0,s.jsx)(n.strong,{children:"Basisregeln"})," zentral."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"baseline-namespaceseitig--default-deny",children:"Baseline (Namespaceseitig) \u2013 Default Deny"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny\n  namespace: myns\nspec:\n  podSelector: {}\n  policyTypes: [Ingress, Egress]\n"})}),"\n",(0,s.jsx)(n.h3,{id:"allow-ingress-vom-ingress-controller--dns-egress",children:"Allow: Ingress vom Ingress-Controller + DNS Egress"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-ingress-from-gateway\n  namespace: myns\nspec:\n  podSelector:\n    matchLabels:\n      app: web\n  ingress:\n    - from:\n        - namespaceSelector:\n            matchLabels:\n              kubernetes.io/metadata.name: ingress-nginx\n  egress:\n    - to:\n        - namespaceSelector:\n            matchLabels:\n              kubernetes.io/metadata.name: kube-system\n      ports:\n        - protocol: UDP\n          port: 53\n"})}),"\n",(0,s.jsx)(a.A,{type:"note",title:"Test",children:(0,s.jsxs)(n.p,{children:["Validiere Policies mit ",(0,s.jsx)(n.code,{children:"netshoot"}),", ",(0,s.jsx)(n.code,{children:"curl"}),", ",(0,s.jsx)(n.code,{children:"dig"})," und CI\u2011Checks (z.\u202fB. Kyverno/OPA\u2011Constraints). Automatisierte Smoke\u2011Tests sind Gold wert."]})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-netzwerk-setup-bew\xe4hrte-optionen",children:"\ud83c\udf10 Netzwerk-Setup: bew\xe4hrte Optionen"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Outbound"}),": ",(0,s.jsx)(n.code,{children:"managedNATGateway"})," oder ",(0,s.jsx)(n.code,{children:"userDefinedRouting"})," mit Azure Firewall."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Private Cluster"}),": Private Endpoint + DNS Zonen, Jump\u2011Host/Bastion f\xfcr ",(0,s.jsx)(n.code,{children:"kubectl"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Ingress"}),": AGIC oder NGINX; bei Private Cluster \u2192 interne LoadBalancer/Private Link."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Egress\u2011Lockdown"}),": Azure Firewall DNAT/Anwendungsregeln; Policies f\xfcr verbotene Public\u2011IPs."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pattern:"})," Netz\u2011Modul liefert ",(0,s.jsx)(n.strong,{children:"Subnet\u2011IDs"}),"/Routen als Outputs an das AKS\u2011Modul; keine zirkul\xe4ren Abh\xe4ngigkeiten."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-environments-workspaces--state",children:"\ud83e\uddea Environments, Workspaces & State"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Remote State"})," in Azure Storage (Blob) mit ",(0,s.jsx)(n.strong,{children:"State\u2011Locking"})," via Storage Lease."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"One workspace per environment"})," (z.\u202fB. ",(0,s.jsx)(n.code,{children:"dev"}),", ",(0,s.jsx)(n.code,{children:"prod"}),") \u2013 kein Mischen."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"tfvars"})," pro Umgebung + ",(0,s.jsx)(n.code,{children:"locals"})," f\xfcr abgeleitete Werte (Tags, Namenskonventionen, CIDRs)."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'# backend.tf (je Env)\nterraform {\n  backend "azurerm" {}\n  required_version = ">= 1.7.0"\n  required_providers {\n    azurerm = {\n      source  = "hashicorp/azurerm"\n      version = "~> 3.100"\n    }\n  }\n}\n'})}),"\n",(0,s.jsx)(a.A,{type:"tip",title:"Namenskonventionen",children:(0,s.jsxs)(n.p,{children:["Ein ",(0,s.jsx)(n.code,{children:"locals.naming"}),"\u2011Block vereinheitlicht Ressourcennamen \xfcber alle Module (Prefix/Env/Location)."]})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-cicd--sicherheit",children:"\ud83d\udea6 CI/CD & Sicherheit"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Pipeline\u2011Matrix"})," pro Umfeld (Plan/Apply) mit manueller Freigabe f\xfcr prod."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Pre\u2011Commit"}),": ",(0,s.jsx)(n.code,{children:"terraform fmt"}),", ",(0,s.jsx)(n.code,{children:"tflint"}),", ",(0,s.jsx)(n.code,{children:"tfsec"}),"/",(0,s.jsx)(n.code,{children:"checkov"}),", ",(0,s.jsx)(n.code,{children:"terrascan"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Drift Detection"}),": ",(0,s.jsx)(n.code,{children:"terraform plan"})," on schedule \u2192 Slack/Teams\u2011Report."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Plan\u2011Artefakte"})," signieren/archivieren."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Provider\u2011Pins"})," + Renovate/Bump PRs \u2192 reproduzierbare Builds."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pattern:"})," ",(0,s.jsx)(n.code,{children:"make plan ENV=dev"})," ruft ",(0,s.jsx)(n.code,{children:"terraform workspace select dev"})," + ",(0,s.jsx)(n.code,{children:"-var-file=env/dev/variables.tfvars"})," auf \u2013 identische Befehle lokal und in CI."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-komplettes-aks-beispiel-gek\xfcrzt",children:"\ud83d\udce6 Komplettes AKS-Beispiel (gek\xfcrzt)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'module "network" {\n  source              = "../modules/network"\n  name                = local.naming.net\n  location            = var.location\n  address_space       = ["10.40.0.0/16"]\n  subnets = {\n    aks_nodes = {\n      prefix = "10.40.1.0/24"\n      nsg_rules = ["deny_internet_in", "allow_vnet"]\n    }\n  }\n}\n\nmodule "acr" {\n  source              = "../modules/acr"\n  name                = local.naming.acr\n  location            = var.location\n  sku                 = "Standard"\n}\n\nmodule "aks" {\n  source                  = "../modules/aks"\n  name                    = local.naming.aks\n  location                = var.location\n  resource_group_name     = azurerm_resource_group.rg.name\n  kubernetes_version      = var.k8s_version\n  network_profile = {\n    plugin         = "azure"\n    service_cidr   = "10.41.0.0/16"\n    dns_service_ip = "10.41.0.10"\n    outbound_type  = "managedNATGateway"\n  }\n  system_node_pool = {\n    name      = "sys"\n    vm_size   = "Standard_D4s_v5"\n    min_count = 1\n    max_count = 3\n  }\n  user_node_pools = [\n    {\n      name = "user"\n      vm_size = "Standard_D8s_v5"\n      min_count = 2\n      max_count = 10\n      labels = { "kubernetes.azure.com/mode" = "user" }\n    }\n  ]\n  enable_azure_rbac            = true\n  aad_admin_group_object_ids   = var.aad_admin_groups\n}\n\n# Role Assignment f\xfcr Kubelet \u2192 ACR Pull\nresource "azurerm_role_assignment" "kubelet_acr" {\n  scope                = module.acr.id\n  role_definition_name = "AcrPull"\n  principal_id         = module.aks.kubelet_identity_principal_id\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-checkliste--was-gerne-schiefgeht",children:"\ud83e\udded Checkliste \u2013 Was gerne schiefgeht"}),"\n",(0,s.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,s.jsx)(n.code,{children:"AcrPull"})," f\xfcr ",(0,s.jsx)(n.strong,{children:"Kubelet"})," vergessen \u2192 ImagePullBackOff"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Subnet/RT/NAT Rechte fehlen \u2192 AKS Provisioning h\xe4ngt"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Azure RBAC Gruppen nicht propagiert \u2192 Admins k\xf6nnen nicht joinen (abwarten/retry)"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Network Policies greifen nicht (Policy\u2011Engine/CNI passt nicht zur Cluster\u2011Config)"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Private DNS nicht konfiguriert \u2192 Control Plane/Ingress/ACR nicht erreichbar"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Provider\u2011Upgrade ohne Modul\u2011Kapselung \u2192 Breaking Changes \xfcberall"]}),"\n"]}),"\n",(0,s.jsx)(a.A,{type:"caution",title:"Production Readiness",children:(0,s.jsx)(n.p,{children:"Vor Prod\u2011Rollout: e2e\u2011Tests (Deployments, Pull aus ACR, Ingress, DNS, Policy\u2011Smoke), Loadtests, Failover (Node Drain, Pool\u2011Scaling), Backup/Restore (etcd/Velero), Secrets\u2011Pfad (Key Vault + CSI)."})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-fazit",children:"\ud83d\udccc Fazit"}),"\n",(0,s.jsxs)(n.p,{children:["Ein ",(0,s.jsx)(n.strong,{children:"modulares Terraform\u2011Design"})," f\xfcr AKS zahlt sich aus: klarere Zust\xe4ndigkeiten, weniger Drift, reproduzierbare Builds und kontrollierte Sicherheit. Mit sauberem RBAC, durchdachtem Netzwerk\u2011Layout und automatisierten Checks bleibt die Plattform ",(0,s.jsx)(n.strong,{children:"skalierbar"})," und ",(0,s.jsx)(n.strong,{children:"betriebsstabil"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-vollst\xe4ndiges-aksmodul-beispiel",children:"\ud83d\udce6 Vollst\xe4ndiges AKS\u2011Modul (Beispiel)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"modules/aks/main.tf"})})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'resource "azurerm_kubernetes_cluster" "this" {\n  name                = var.name\n  location            = var.location\n  resource_group_name = var.resource_group_name\n  dns_prefix          = "${var.name}-dns"\n  kubernetes_version  = var.kubernetes_version\n\n  identity {\n    type = "SystemAssigned"\n  }\n\n  default_node_pool {\n    name                = var.system_node_pool.name\n    vm_size             = var.system_node_pool.vm_size\n    min_count           = var.system_node_pool.min_count\n    max_count           = var.system_node_pool.max_count\n    enable_auto_scaling = true\n    os_sku              = var.system_node_pool.os_sku\n    mode                = "System"\n  }\n\n  dynamic "agent_pool_profile" {\n    for_each = var.user_node_pools\n    content {\n      name                = agent_pool_profile.value.name\n      vm_size             = agent_pool_profile.value.vm_size\n      min_count           = agent_pool_profile.value.min_count\n      max_count           = agent_pool_profile.value.max_count\n      enable_auto_scaling = true\n      mode                = lookup(agent_pool_profile.value, "mode", "User")\n      node_labels         = lookup(agent_pool_profile.value, "labels", null)\n      node_taints         = lookup(agent_pool_profile.value, "taints", null)\n    }\n  }\n\n  role_based_access_control_enabled = var.enable_azure_rbac\n\n  azure_active_directory_role_based_access_control {\n    managed                = true\n    admin_group_object_ids = var.aad_admin_group_object_ids\n  }\n\n  network_profile {\n    network_plugin     = var.network_profile.plugin\n    service_cidr       = var.network_profile.service_cidr\n    dns_service_ip     = var.network_profile.dns_service_ip\n    pod_cidr           = try(var.network_profile.pod_cidr, null)\n    outbound_type      = var.network_profile.outbound_type\n  }\n}\n\noutput "kubelet_identity_principal_id" {\n  value = azurerm_kubernetes_cluster.this.kubelet_identity[0].object_id\n}\n\noutput "id" {\n  value = azurerm_kubernetes_cluster.this.id\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"modules/aks/variables.tf"})})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'variable "name" { type = string }\nvariable "location" { type = string }\nvariable "resource_group_name" { type = string }\nvariable "kubernetes_version" { type = string }\n\nvariable "network_profile" {\n  type = object({\n    plugin         = string\n    service_cidr   = string\n    dns_service_ip = string\n    pod_cidr       = optional(string)\n    outbound_type  = string\n  })\n}\n\nvariable "enable_azure_rbac" { type = bool }\nvariable "aad_admin_group_object_ids" { type = list(string) }\n\nvariable "system_node_pool" {\n  type = object({\n    name      = string\n    vm_size   = string\n    min_count = number\n    max_count = number\n    os_sku    = optional(string, "Ubuntu")\n  })\n}\n\nvariable "user_node_pools" {\n  type = list(object({\n    name      = string\n    vm_size   = string\n    min_count = number\n    max_count = number\n    mode      = optional(string, "User")\n    labels    = optional(map(string))\n    taints    = optional(list(string))\n  }))\n  default = []\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-azure-devops-pipeline-f\xfcr-terraform-aks",children:"\ud83d\ude80 Azure DevOps Pipeline f\xfcr Terraform AKS"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:".azure-pipelines/terraform-aks.yml"})})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"trigger:\n  branches:\n    include:\n      - main\n\nvariables:\n  TF_VERSION: '1.7.5'\n  AZURE_SUBSCRIPTION: 'MyServiceConnection'\n  ENVIRONMENT: 'dev'\n\nstages:\n  - stage: validate\n    displayName: \"Terraform Validate & Lint\"\n    jobs:\n      - job: lint\n        pool:\n          vmImage: 'ubuntu-latest'\n        steps:\n          - task: UseTerraform@0\n            inputs:\n              terraformVersion: $(TF_VERSION)\n          - script: |\n              terraform fmt -check -recursive\n              terraform init -backend=false\n              terraform validate\n            displayName: \"Terraform fmt & validate\"\n          - script: |\n              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash\n              tflint --recursive\n            displayName: \"Run TFLint\"\n\n  - stage: plan\n    displayName: \"Terraform Plan\"\n    dependsOn: validate\n    jobs:\n      - job: plan\n        pool:\n          vmImage: 'ubuntu-latest'\n        steps:\n          - task: UseTerraform@0\n            inputs:\n              terraformVersion: $(TF_VERSION)\n          - task: TerraformCLI@0\n            displayName: \"Terraform Init\"\n            inputs:\n              command: 'init'\n              backendType: 'azurerm'\n              backendServiceArm: $(AZURE_SUBSCRIPTION)\n              ensureBackend: true\n              workingDirectory: 'infra/env/$(ENVIRONMENT)'\n          - task: TerraformCLI@0\n            displayName: \"Terraform Plan\"\n            inputs:\n              command: 'plan'\n              environmentServiceName: $(AZURE_SUBSCRIPTION)\n              workingDirectory: 'infra/env/$(ENVIRONMENT)'\n              vars: |\n                environment=$(ENVIRONMENT)\n          - publish: $(System.DefaultWorkingDirectory)/infra/env/$(ENVIRONMENT)/tfplan\n            artifact: tfplan\n\n  - stage: apply\n    displayName: \"Terraform Apply\"\n    dependsOn: plan\n    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))\n    jobs:\n      - deployment: apply\n        environment: aks-$(ENVIRONMENT)\n        pool:\n          vmImage: 'ubuntu-latest'\n        strategy:\n          runOnce:\n            deploy:\n              steps:\n                - task: UseTerraform@0\n                  inputs:\n                    terraformVersion: $(TF_VERSION)\n                - download: current\n                  artifact: tfplan\n                - task: TerraformCLI@0\n                  displayName: \"Terraform Apply\"\n                  inputs:\n                    command: 'apply'\n                    environmentServiceName: $(AZURE_SUBSCRIPTION)\n                    workingDirectory: 'infra/env/$(ENVIRONMENT)'\n                    commandOptions: \"tfplan\"\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-ergebnis",children:"\ud83d\udccc Ergebnis"}),"\n",(0,s.jsxs)(n.p,{children:["Mit einem ",(0,s.jsx)(n.strong,{children:"klar gekapselten AKS-Modul"})," und einer ",(0,s.jsx)(n.strong,{children:"CI/CD-Pipeline in Azure DevOps"})," erh\xe4ltst du:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"reproduzierbare Cluster-Deployments"}),"\n",(0,s.jsx)(n.li,{children:"automatisierte Validierung (fmt, validate, lint)"}),"\n",(0,s.jsx)(n.li,{children:"Plan-Review mit Artefakten"}),"\n",(0,s.jsx)(n.li,{children:"manuelles oder automatisiertes Apply mit Service Connection"}),"\n",(0,s.jsx)(n.li,{children:"einfache Erweiterbarkeit (Drift Detection, Security Scans)"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-produktionsreifes-aksmodul-terraform",children:"\ud83e\udde9 Produktionsreifes AKS\u2011Modul (Terraform)"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Struktur (als Beispiel):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"modules/aks/\n\u251c\u2500 main.tf\n\u251c\u2500 variables.tf\n\u251c\u2500 outputs.tf\n\u2514\u2500 README.md\n"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"modules/aks/variables.tf"})})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'variable "name" { type = string }\nvariable "location" { type = string }\nvariable "resource_group_name" { type = string }\n\nvariable "kubernetes_version" { type = string }\n\nvariable "tags" { type = map(string), default = {} }\n\nvariable "identity_type" {\n  description = "system | user"\n  type        = string\n  default     = "system"\n  validation {\n    condition     = contains(["system", "user"], var.identity_type)\n    error_message = "identity_type must be \'system\' or \'user\'"\n  }\n}\n\nvariable "user_assigned_identity_ids" {\n  description = "Only used when identity_type=user"\n  type        = list(string)\n  default     = []\n}\n\nvariable "network_profile" {\n  type = object({\n    plugin           = string                    # azure | kubenet | cni_overlay\n    service_cidr     = string\n    dns_service_ip   = string\n    pod_cidr         = optional(string)\n    outbound_type    = optional(string, "managedNATGateway") # loadBalancer | userDefinedRouting | managedNATGateway\n    network_policy   = optional(string, null)   # azure | calico | null\n  })\n}\n\nvariable "private_cluster_enabled" { type = bool, default = false }\nvariable "api_server_authorized_ip_ranges" { type = list(string), default = [] }\n\nvariable "aad_admin_group_object_ids" { type = list(string), default = [] }\nvariable "enable_azure_rbac" { type = bool, default = true }\n\nvariable "oms_workspace_resource_id" { type = string, default = null }\nvariable "enable_azure_policy_addon" { type = bool, default = false }\n\nvariable "system_node_pool" {\n  type = object({\n    name               = string\n    vm_size            = string\n    min_count          = number\n    max_count          = number\n    os_disk_size_gb    = optional(number, 128)\n    os_sku             = optional(string, "Ubuntu")\n    node_labels        = optional(map(string), {})\n    node_taints        = optional(list(string), [])\n    zones              = optional(list(string), null)\n  })\n}\n\nvariable "user_node_pools" {\n  description = "List of additional user pools"\n  type = list(object({\n    name               = string\n    vm_size            = string\n    min_count          = number\n    max_count          = number\n    os_disk_size_gb    = optional(number, 128)\n    os_sku             = optional(string, "Ubuntu")\n    node_labels        = optional(map(string), {})\n    node_taints        = optional(list(string), [])\n    mode               = optional(string, "User")\n    zones              = optional(list(string), null)\n  }))\n  default = []\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"modules/aks/main.tf"})})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'# Hinweis: Provider-Konfiguration (azurerm) wird au\xdferhalb des Moduls gesetzt.\n\nlocals {\n  identity_block = var.identity_type == "user" ? {\n    type         = "UserAssigned"\n    identity_ids = var.user_assigned_identity_ids\n  } : {\n    type = "SystemAssigned"\n  }\n}\n\nresource "azurerm_kubernetes_cluster" "this" {\n  name                = var.name\n  location            = var.location\n  resource_group_name = var.resource_group_name\n  kubernetes_version  = var.kubernetes_version\n  dns_prefix          = replace(var.name, ".", "-")\n\n  identity {\n    type         = local.identity_block.type\n    identity_ids = try(local.identity_block.identity_ids, null)\n  }\n\n  default_node_pool {\n    name                 = var.system_node_pool.name\n    vm_size              = var.system_node_pool.vm_size\n    orchestrator_version = var.kubernetes_version\n    min_count            = var.system_node_pool.min_count\n    max_count            = var.system_node_pool.max_count\n    enable_auto_scaling  = true\n    os_sku               = var.system_node_pool.os_sku\n    os_disk_size_gb      = var.system_node_pool.os_disk_size_gb\n    node_labels          = var.system_node_pool.node_labels\n    node_taints          = var.system_node_pool.node_taints\n    zones                = var.system_node_pool.zones\n    upgrade_settings {\n      max_surge = "33%"\n    }\n  }\n\n  network_profile {\n    network_plugin    = var.network_profile.plugin\n    service_cidr      = var.network_profile.service_cidr\n    dns_service_ip    = var.network_profile.dns_service_ip\n    network_policy    = var.network_profile.network_policy\n    outbound_type     = var.network_profile.outbound_type\n    pod_cidr          = try(var.network_profile.pod_cidr, null)\n  }\n\n  api_server_access_profile {\n    authorized_ip_ranges = var.api_server_authorized_ip_ranges\n  }\n\n  azure_active_directory_role_based_access_control {\n    enabled                        = true\n    azure_rbac_enabled             = var.enable_azure_rbac\n    admin_group_object_ids         = var.aad_admin_group_object_ids\n  }\n\n  # Add-ons\n  dynamic "oms_agent" {\n    for_each = var.oms_workspace_resource_id == null ? [] : [1]\n    content {\n      log_analytics_workspace_id = var.oms_workspace_resource_id\n    }\n  }\n\n  azure_policy_enabled        = var.enable_azure_policy_addon\n  private_cluster_enabled     = var.private_cluster_enabled\n\n  sku_tier = "Paid" # Uptime SLA optional, anpassbar\n\n  tags = var.tags\n}\n\n# Zus\xe4tzliche User Node Pools\nresource "azurerm_kubernetes_cluster_node_pool" "user" {\n  for_each = { for p in var.user_node_pools : p.name => p }\n\n  kubernetes_cluster_id = azurerm_kubernetes_cluster.this.id\n  name                  = each.value.name\n  vm_size               = each.value.vm_size\n  orchestrator_version  = var.kubernetes_version\n  mode                  = try(each.value.mode, "User")\n  min_count             = each.value.min_count\n  max_count             = each.value.max_count\n  enable_auto_scaling   = true\n  os_disk_size_gb       = try(each.value.os_disk_size_gb, 128)\n  os_sku                = try(each.value.os_sku, "Ubuntu")\n  node_labels           = try(each.value.node_labels, {})\n  node_taints           = try(each.value.node_taints, [])\n  zones                 = try(each.value.zones, null)\n\n  tags = var.tags\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"modules/aks/outputs.tf"})})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'output "id" { value = azurerm_kubernetes_cluster.this.id }\noutput "kubelet_identity_principal_id" {\n  value = try(azurerm_kubernetes_cluster.this.kubelet_identity[0].object_id, null)\n}\noutput "principal_id" { # Cluster (control plane) MI bei SystemAssigned\n  value = try(azurerm_kubernetes_cluster.this.identity[0].principal_id, null)\n}\noutput "host" { value = azurerm_kubernetes_cluster.this.kube_config[0].host }\noutput "name" { value = azurerm_kubernetes_cluster.this.name }\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"modules/aks/README.md"})})," (Kurz)"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-md",children:"Inputs kapseln AKS-Details (RBAC, Network, Private Cluster). Provider au\xdferhalb konfigurieren. Role Assignments (ACR Pull, Subnet/RouteTable) au\xdferhalb setzen.\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"-azure-devops-pipeline-terraform-planapply-multienv",children:"\ud83d\udd01 Azure DevOps Pipeline (Terraform Plan/Apply, Multi\u2011Env)"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Voraussetzungen"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Azure DevOps ",(0,s.jsx)(n.strong,{children:"Service Connection"})," (ARM) mit ",(0,s.jsx)(n.strong,{children:"Workload Identity/Federated Credentials"})," f\xfcr Subscription/Resource Group."]}),"\n",(0,s.jsx)(n.li,{children:"Azure Storage Backend f\xfcr Terraform State (Container + Blob Locking via Lease)."}),"\n",(0,s.jsxs)(n.li,{children:["Optional: Variable Groups f\xfcr ",(0,s.jsx)(n.code,{children:"ARM_*"}),"/Backend\u2011Parameter."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.code,{children:"azure-pipelines.yml"})})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'trigger:\n  branches:\n    include: [ main ]\npr:\n  branches:\n    include: [ main, feature/* ]\n\nvariables:\n  TF_VERSION: \'1.8.5\'\n  PROVIDER_AZURERM: \'~> 3.113\'\n  # Backend (per Variable Group setzbar)\n  TF_BACKEND_RG: \'rg-tfstate\'\n  TF_BACKEND_SA: \'sttfstate1234\'\n  TF_BACKEND_CONTAINER: \'tfstate\'\n  TF_BACKEND_KEY: \'$(Build.Repository.Name).$(System.StageName).tfstate\'\n\nstages:\n- stage: Validate\n  displayName: "Validate & Security Checks"\n  jobs:\n  - job: validate\n    pool: { vmImage: \'ubuntu-latest\' }\n    steps:\n    - checkout: self\n    - task: Bash@3\n      displayName: "Install Terraform $(TF_VERSION)"\n      inputs:\n        targetType: \'inline\'\n        script: |\n          curl -sLo tf.zip https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip\n          sudo unzip -o tf.zip -d /usr/local/bin\n          terraform -version\n    - task: Bash@3\n      displayName: "Terraform fmt & init"\n      env:\n        ARM_USE_OIDC: true\n      inputs:\n        targetType: \'inline\'\n        script: |\n          cd infra/env/dev\n          terraform init \\\n            -backend-config="resource_group_name=$(TF_BACKEND_RG)" \\\n            -backend-config="storage_account_name=$(TF_BACKEND_SA)" \\\n            -backend-config="container_name=$(TF_BACKEND_CONTAINER)" \\\n            -backend-config="key=$(TF_BACKEND_KEY)"\n          terraform fmt -check -recursive\n          terraform validate\n    - task: Bash@3\n      displayName: "tflint / tfsec"\n      inputs:\n        targetType: \'inline\'\n        script: |\n          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash\n          tflint --version\n          tflint -f compact || true\n          curl -sL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash\n          tfsec . || true\n\n- stage: Plan\n  displayName: "Plan (Dev)"\n  dependsOn: Validate\n  jobs:\n  - job: plan_dev\n    displayName: "terraform plan dev"\n    pool: { vmImage: \'ubuntu-latest\' }\n    steps:\n    - checkout: self\n    - task: AzureCLI@2\n      displayName: "Terraform init+plan (OIDC)"\n      inputs:\n        azureSubscription: \'AZURE-SP-WI\'   # Name eurer Service Connection\n        scriptType: bash\n        scriptLocation: inlineScript\n        inlineScript: |\n          set -e\n          cd infra/env/dev\n          terraform init \\\n            -backend-config="resource_group_name=$(TF_BACKEND_RG)" \\\n            -backend-config="storage_account_name=$(TF_BACKEND_SA)" \\\n            -backend-config="container_name=$(TF_BACKEND_CONTAINER)" \\\n            -backend-config="key=$(TF_BACKEND_KEY)"\n          terraform workspace select dev || terraform workspace new dev\n          terraform plan -var-file=variables.tfvars -out=tfplan\n    - publish: infra/env/dev/tfplan\n      displayName: "Publish plan artifact"\n      artifact: tfplan-dev\n\n- stage: Apply\n  displayName: "Apply (Dev)"\n  dependsOn: Plan\n  condition: and(succeeded(), eq(variables[\'Build.SourceBranch\'], \'refs/heads/main\'))\n  jobs:\n  - deployment: apply_dev\n    displayName: "terraform apply dev"\n    environment: dev # optional: Environments mit Approvals sch\xfctzen\n    strategy:\n      runOnce:\n        deploy:\n          steps:\n          - checkout: self\n          - task: AzureCLI@2\n            displayName: "Terraform init+apply"\n            inputs:\n              azureSubscription: \'AZURE-SP-WI\'\n              scriptType: bash\n              scriptLocation: inlineScript\n              inlineScript: |\n                set -e\n                cd infra/env/dev\n                terraform init \\\n                  -backend-config="resource_group_name=$(TF_BACKEND_RG)" \\\n                  -backend-config="storage_account_name=$(TF_BACKEND_SA)" \\\n                  -backend-config="container_name=$(TF_BACKEND_CONTAINER)" \\\n                  -backend-config="key=$(TF_BACKEND_KEY)"\n                terraform workspace select dev || terraform workspace new dev\n                terraform apply -auto-approve tfplan\n\n- stage: Plan_Prod\n  displayName: "Plan (Prod)"\n  dependsOn: Apply\n  condition: and(succeeded(), eq(variables[\'Build.SourceBranch\'], \'refs/heads/main\'))\n  jobs:\n  - job: plan_prod\n    pool: { vmImage: \'ubuntu-latest\' }\n    steps:\n    - checkout: self\n    - task: AzureCLI@2\n      displayName: "Plan prod"\n      inputs:\n        azureSubscription: \'AZURE-SP-WI\'\n        scriptType: bash\n        scriptLocation: inlineScript\n        inlineScript: |\n          set -e\n          cd infra/env/prod\n          terraform init \\\n            -backend-config="resource_group_name=$(TF_BACKEND_RG)" \\\n            -backend-config="storage_account_name=$(TF_BACKEND_SA)" \\\n            -backend-config="container_name=$(TF_BACKEND_CONTAINER)" \\\n            -backend-config="key=$(TF_BACKEND_KEY)"\n          terraform workspace select prod || terraform workspace new prod\n          terraform plan -var-file=variables.tfvars -out=tfplan\n    - publish: infra/env/prod/tfplan\n      artifact: tfplan-prod\n\n- stage: Apply_Prod\n  displayName: "Apply (Prod)"\n  dependsOn: Plan_Prod\n  condition: and(succeeded(), eq(variables[\'Build.SourceBranch\'], \'refs/heads/main\'))\n  jobs:\n  - deployment: apply_prod\n    displayName: "terraform apply prod"\n    environment: prod # Enforce manual approval in ADO Environment\n    strategy:\n      runOnce:\n        deploy:\n          steps:\n          - checkout: self\n          - task: AzureCLI@2\n            displayName: "Apply prod"\n            inputs:\n              azureSubscription: \'AZURE-SP-WI\'\n              scriptType: bash\n              scriptLocation: inlineScript\n              inlineScript: |\n                set -e\n                cd infra/env/prod\n                terraform init \\\n                  -backend-config="resource_group_name=$(TF_BACKEND_RG)" \\\n                  -backend-config="storage_account_name=$(TF_BACKEND_SA)" \\\n                  -backend-config="container_name=$(TF_BACKEND_CONTAINER)" \\\n                  -backend-config="key=$(TF_BACKEND_KEY)"\n                terraform workspace select prod || terraform workspace new prod\n                terraform apply -auto-approve tfplan\n'})}),"\n",(0,s.jsx)(n.h3,{id:"hinweise--best-practices",children:"Hinweise & Best Practices"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"OIDC/Federated Credentials:"})," Service Connection so konfigurieren, dass kein Secret n\xf6tig ist (kein Service Principal Passwort im Repo)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"State pro Stage:"})," Der Key ",(0,s.jsx)(n.code,{children:"$(System.StageName)"})," im Backend trennt dev/prod sauber."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Security Scans:"})," ",(0,s.jsx)(n.code,{children:"tflint"}),"/",(0,s.jsx)(n.code,{children:"tfsec"})," sind ",(0,s.jsx)(n.code,{children:"|| true"}),", damit Warnungen den Build nicht hart brechen \u2013 in Prod optional erzwingen."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Approvals:"})," Azure DevOps ",(0,s.jsx)(n.strong,{children:"Environments"})," f\xfcr manuelle Freigaben zwischen Stufen nutzen."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Parallel Envs:"})," F\xfcr mehrere Envs ",(0,s.jsx)(n.code,{children:"strategy: matrix"})," in Plan/Apply nutzen oder Envs als separate Stages definieren."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h2,{id:"-beispiel-verwendung-des-aksmoduls-in-infraenvdevmaintf",children:["\ud83d\udd17 Beispiel: Verwendung des AKS\u2011Moduls in ",(0,s.jsx)(n.code,{children:"infra/env/dev/main.tf"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'terraform {\n  required_version = ">= 1.8.0"\n  required_providers {\n    azurerm = {\n      source  = "hashicorp/azurerm"\n      version = "~> 3.113"\n    }\n  }\n  backend "azurerm" {}\n}\n\nprovider "azurerm" {\n  features {}\n  use_oidc = true\n}\n\nlocals {\n  tags = {\n    env   = "dev"\n    owner = "platform"\n  }\n}\n\nresource "azurerm_resource_group" "rg" {\n  name     = "rg-aks-dev"\n  location = var.location\n  tags     = local.tags\n}\n\nmodule "aks" {\n  source              = "../../modules/aks"\n  name                = "aks-dev-core"\n  location            = var.location\n  resource_group_name = azurerm_resource_group.rg.name\n  kubernetes_version  = var.k8s_version\n  tags                = local.tags\n\n  identity_type = "system"\n\n  network_profile = {\n    plugin         = "azure"\n    service_cidr   = "10.50.0.0/16"\n    dns_service_ip = "10.50.0.10"\n    outbound_type  = "managedNATGateway"\n    network_policy = "azure"\n  }\n\n  aad_admin_group_object_ids = var.aad_admin_groups\n  enable_azure_rbac          = true\n\n  private_cluster_enabled           = false\n  api_server_authorized_ip_ranges   = []\n\n  system_node_pool = {\n    name      = "sys"\n    vm_size   = "Standard_D4s_v5"\n    min_count = 1\n    max_count = 2\n    node_labels = {\n      "kubernetes.azure.com/mode" = "system"\n    }\n  }\n\n  user_node_pools = [\n    {\n      name      = "user"\n      vm_size   = "Standard_D8s_v5"\n      min_count = 2\n      max_count = 6\n      node_labels = {\n        "kubernetes.azure.com/mode" = "user"\n      }\n    }\n  ]\n}\n\n# Beispiel: ACR + Role Assignment (au\xdferhalb des Moduls)\nresource "azurerm_container_registry" "acr" {\n  name                = "acrdevexample1234"\n  resource_group_name = azurerm_resource_group.rg.name\n  location            = var.location\n  sku                 = "Standard"\n  admin_enabled       = false\n  tags                = local.tags\n}\n\nresource "azurerm_role_assignment" "kubelet_acr_pull" {\n  scope                = azurerm_container_registry.acr.id\n  role_definition_name = "AcrPull"\n  principal_id         = module.aks.kubelet_identity_principal_id\n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},4820:e=>{e.exports=JSON.parse('{"permalink":"/blog/terraform-patterns-aks-azure","source":"@site/blog/2025-02-03-terraform-patterns.md","title":"Terraform Patterns f\xfcr AKS & Azure","description":"Erfahrungen mit modularen Terraform-Setups f\xfcr AKS \u2013 von Modul-Design \xfcber RBAC bis zu Network Policies und CI/CD.","date":"2025-02-03T00:00:00.000Z","tags":[{"inline":false,"label":"Terraform","permalink":"/blog/tags/terraform","description":"Terraform"},{"inline":false,"label":"AKS","permalink":"/blog/tags/aks","description":"Azure Kubernetes Service"},{"inline":false,"label":"Azure","permalink":"/blog/tags/azure","description":"Azure"},{"inline":false,"label":"RBAC","permalink":"/blog/tags/rbac","description":"Role-Based Access Control"},{"inline":false,"label":"Network Policy","permalink":"/blog/tags/network-policy","description":"Network Policy"},{"inline":false,"label":"Modules","permalink":"/blog/tags/modules","description":"Modules"},{"inline":false,"label":"CI/CD","permalink":"/blog/tags/cicd","description":"Continuous Integration and Continuous Deployment"}],"readingTime":13.33,"hasTruncateMarker":true,"authors":[{"name":"Brigitte B\xf6hm","title":"Cloud & Data Platform Engineer","url":"https://www.linkedin.com/in/brigitte-boehm-34b7a025","page":{"permalink":"/blog/authors/brigitte"},"socials":{"github":"https://github.com/bri-b-dev","linkedin":"https://www.linkedin.com/in/brigitte-boehm-34b7a025"},"imageURL":"https://github.com/bri-b-dev.png","key":"brigitte"}],"frontMatter":{"slug":"terraform-patterns-aks-azure","title":"Terraform Patterns f\xfcr AKS & Azure","authors":"brigitte","tags":["terraform","aks","azure","rbac","network-policy","modules","cicd"],"date":"2025-02-03T00:00:00.000Z","description":"Erfahrungen mit modularen Terraform-Setups f\xfcr AKS \u2013 von Modul-Design \xfcber RBAC bis zu Network Policies und CI/CD."},"unlisted":false,"prevItem":{"title":"API-First mit Spring Boot & Kotlin","permalink":"/blog/api-first-springboot-kotlin"},"nextItem":{"title":"AKS Node Selection: Physische Pools vs. Virtual Nodes","permalink":"/blog/aks-node-selection"}}')},7293:(e,n,r)=>{r.d(n,{A:()=>R});var i=r(6540),s=r(4848);function t(e){const{mdxAdmonitionTitle:n,rest:r}=function(e){const n=i.Children.toArray(e),r=n.find(e=>i.isValidElement(e)&&"mdxAdmonitionTitle"===e.type),t=n.filter(e=>e!==r),a=r?.props.children;return{mdxAdmonitionTitle:a,rest:t.length>0?(0,s.jsx)(s.Fragment,{children:t}):null}}(e.children),t=e.title??n;return{...e,...t&&{title:t},children:r}}var a=r(4164),l=r(1312),o=r(7559);const c="admonition_xJq3",d="admonitionHeading_Gvgb",u="admonitionIcon_Rf37",p="admonitionContent_BuS1";function m({type:e,className:n,children:r}){return(0,s.jsx)("div",{className:(0,a.A)(o.G.common.admonition,o.G.common.admonitionType(e),c,n),children:r})}function _({icon:e,title:n}){return(0,s.jsxs)("div",{className:d,children:[(0,s.jsx)("span",{className:u,children:e}),n]})}function h({children:e}){return e?(0,s.jsx)("div",{className:p,children:e}):null}function g(e){const{type:n,icon:r,title:i,children:t,className:a}=e;return(0,s.jsxs)(m,{type:n,className:a,children:[i||r?(0,s.jsx)(_,{title:i,icon:r}):null,(0,s.jsx)(h,{children:t})]})}function v(e){return(0,s.jsx)("svg",{viewBox:"0 0 14 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})})}const b={icon:(0,s.jsx)(v,{}),title:(0,s.jsx)(l.A,{id:"theme.admonition.note",description:"The default label used for the Note admonition (:::note)",children:"note"})};function f(e){return(0,s.jsx)(g,{...b,...e,className:(0,a.A)("alert alert--secondary",e.className),children:e.children})}function k(e){return(0,s.jsx)("svg",{viewBox:"0 0 12 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"})})}const x={icon:(0,s.jsx)(k,{}),title:(0,s.jsx)(l.A,{id:"theme.admonition.tip",description:"The default label used for the Tip admonition (:::tip)",children:"tip"})};function j(e){return(0,s.jsx)(g,{...x,...e,className:(0,a.A)("alert alert--success",e.className),children:e.children})}function y(e){return(0,s.jsx)("svg",{viewBox:"0 0 14 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})})}const A={icon:(0,s.jsx)(y,{}),title:(0,s.jsx)(l.A,{id:"theme.admonition.info",description:"The default label used for the Info admonition (:::info)",children:"info"})};function z(e){return(0,s.jsx)(g,{...A,...e,className:(0,a.A)("alert alert--info",e.className),children:e.children})}function N(e){return(0,s.jsx)("svg",{viewBox:"0 0 16 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"})})}const w={icon:(0,s.jsx)(N,{}),title:(0,s.jsx)(l.A,{id:"theme.admonition.warning",description:"The default label used for the Warning admonition (:::warning)",children:"warning"})};function S(e){return(0,s.jsx)("svg",{viewBox:"0 0 12 16",...e,children:(0,s.jsx)("path",{fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"})})}const C={icon:(0,s.jsx)(S,{}),title:(0,s.jsx)(l.A,{id:"theme.admonition.danger",description:"The default label used for the Danger admonition (:::danger)",children:"danger"})};const P={icon:(0,s.jsx)(N,{}),title:(0,s.jsx)(l.A,{id:"theme.admonition.caution",description:"The default label used for the Caution admonition (:::caution)",children:"caution"})};const T={...{note:f,tip:j,info:z,warning:function(e){return(0,s.jsx)(g,{...w,...e,className:(0,a.A)("alert alert--warning",e.className),children:e.children})},danger:function(e){return(0,s.jsx)(g,{...C,...e,className:(0,a.A)("alert alert--danger",e.className),children:e.children})}},...{secondary:e=>(0,s.jsx)(f,{title:"secondary",...e}),important:e=>(0,s.jsx)(z,{title:"important",...e}),success:e=>(0,s.jsx)(j,{title:"success",...e}),caution:function(e){return(0,s.jsx)(g,{...P,...e,className:(0,a.A)("alert alert--warning",e.className),children:e.children})}}};function R(e){const n=t(e),r=(i=n.type,T[i]||(console.warn(`No admonition component found for admonition type "${i}". Using Info as fallback.`),T.info));var i;return(0,s.jsx)(r,{...n})}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>l});var i=r(6540);const s={},t=i.createContext(s);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);